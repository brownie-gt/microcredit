<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <p:tab id="tabAbonos" title="Abonos">
        <p:messages showDetail="true" autoUpdate="true" closable="true"/>

        <ui:include src="/cuadre/fechaCuadre.xhtml"/>
        <p:focus id="idCreditoFocus" context="formCuadre:dtAbonos:colNo"/>

        <p:dataTable id="dtAbonos" var="credit" value="#{cuadreView.creditosCuadre}" editable="true" 
                     selection="#{cuadreView.creditosSeleccionados}" rowKey="#{credit.credito.idCredito}"
                     filteredValue="#{cuadreView.filteredCreditosCuadre}" editMode="cell" 
                     widgetVar="wvAbonos"> 
                 
            

            <!-- ****************************** CHECK BOX ****************************** -->
            <p:column selectionMode="multiple" width="3%" style="padding: 4px; text-align:center" />
            
            
            <!-- ****************************** RUTA ****************************** -->
            <p:column headerText="Ruta" width="11%" sortBy="#{credit.credito.idRuta.nombre}"
                      filterBy="#{credit.credito.idRuta.nombre}" filterMatchMode="contains" filterStyle="width:90%;">
                <h:outputText value="#{credit.credito.idRuta.nombre.length() gt 11 ? credit.credito.idRuta.nombre.substring(0,8).concat('...') : credit.credito.idRuta.nombre}"/>
               
            </p:column>

            
            <!-- ****************************** CLIENTE ****************************** -->
            <p:column headerText="Cliente" width="33%" 
                      filterBy="#{credit.credito.idCliente.primerNombre}||#{credit.credito.idCliente.segundoNombre}||#{credit.credito.idCliente.primerApellido}||#{credit.credito.idCliente.segundoApellido}" 
                      filterMatchMode="contains" >
                <h:outputText value="#{credit.credito.idCliente.primerNombre}" rendered="#{not empty credit.credito.idCliente.primerNombre}"/>
                <h:outputText value=" #{credit.credito.idCliente.segundoNombre}" rendered="#{not empty credit.credito.idCliente.segundoNombre}"/>
                <h:outputText value=" #{credit.credito.idCliente.primerApellido}" rendered="#{not empty credit.credito.idCliente.primerApellido}"/>
                <h:outputText value=" #{credit.credito.idCliente.segundoApellido}" rendered="#{not empty credit.credito.idCliente.segundoApellido}"/>
            </p:column>
            
            
            <!-- ****************************** VER ABONOS ****************************** -->
            <p:column style="width:32px;text-align: center">
                <p:commandButton update=":formCuadre:creditDetail" oncomplete="PF('creditDialog').show()" 
                                 icon="ui-icon-search" title="Ver Abonos"  style="width:30px;height:25px">
                    <f:setPropertyActionListener value="#{credit}" target="#{cuadreView.creditoSeleccionado}" />
                </p:commandButton>
            </p:column>
            
            
            <!-- ****************************** FECHA DESEMBOLSO ****************************** -->
            <p:column width="10%" sortBy="#{credit.credito.fechaDesembolso}" style="text-align: center;">
                <f:facet name="header">
                    <h:outputText value="F. Desem." title="Fecha de Desembolso"/>
                </f:facet>
                <h:outputText id="fechaId" value="#{credit.credito.fechaDesembolso}" >
                    <f:convertDateTime pattern="dd-MMM-yy" locale="es_GT"/>
                </h:outputText>
            </p:column>
            
            <!-- ****************************** FECHA VENCIMIENTO ****************************** -->
            <p:column width="10%" sortBy="#{credit.credito.fechaVencimiento}" style="text-align: center; font-weight: bold; ">
                <f:facet name="header">
                    <h:outputText value="F. Venc." title="Fecha de Vencimiento"/>
                </f:facet>
                <h:outputText id="fechaVenc" value="#{credit.credito.fechaVencimiento}" 
                              style="color: #{cuadreView.todaysDate gt credit.credito.fechaVencimiento ? 'red' : ''};" >
                    <f:convertDateTime pattern="dd-MMM-yy" locale="es_GT"/>
                </h:outputText>
            </p:column>
            
            
            <!-- ****************************** ID CREDITO ****************************** -->
            <p:column id="colNo" filterBy="#{credit.credito.idCredito}" filterMatchMode="exact" 
                      width="7%" sortBy="#{credit.credito.idCredito}" selectRow="true" 
                      filterValue="#{cuadreView.filterIdCredito}" filterStyle="width:90%;" style="text-align: center;">
                <f:facet name="header"><h:outputText value="No." title="Numero de tarjeta"/></f:facet>
                <h:outputText id="creditoId" value="#{credit.credito.idCredito}" />
            </p:column>

            
            <!-- ****************************** CUOTA ****************************** -->
            <p:column width="5%" style="text-align: right;" sortBy="#{credit.cuota}">
                 <f:facet name="header">
                    <h:outputText value="C." title="Cuota"/>
                </f:facet>
                <p:cellEditor>
                    <f:facet name="output"><h:outputText value="#{credit.cuota}" >
                            <f:convertNumber pattern="###,###"/>
                        </h:outputText></f:facet>
                    <f:facet name="input"><p:inputText id="modelInput" value="#{credit.cuota}" style="width:100%"/></f:facet>
                </p:cellEditor>
            </p:column>
            
            
            <!-- ****************************** FALLAS ****************************** -->
            <p:column  width="3%" style="text-align: center; padding: 4px;">
                <f:facet name="header">
                    <h:outputText value="F." title="Falla"/>
                </f:facet>
                <p:selectBooleanCheckbox value="#{credit.falla}">
                    <p:ajax listener="#{cuadreView.removerCuota(credit)}" oncomplete="PF('wvAbonos').clearFilters();"
                            update="dtAbonos,:formCuadre:idCreditoFocus"/>

                </p:selectBooleanCheckbox>
            </p:column>
            

            <!-- ****************************** SALDO POR COBRAR ****************************** -->
            <p:column width="7%" style="color: red; text-align: right;" sortBy="#{credit.saldoPorPagar}">
                <f:facet name="header"><h:outputText value="Saldo" title="Saldo por cobrar" /></f:facet>
                <h:outputText value="#{credit.saldoPorPagar}" ><f:convertNumber pattern="###,###"/></h:outputText>
            </p:column>
            
            
            <!-- ****************************** NUMERO DE ABONOS ****************************** -->
            <p:column width="4%" style="color: blue; text-align: center;" sortBy="#{credit.numeroAbonos}">
                <f:facet name="header">
                    <h:outputText value="#" title="Numero de Abonos" />
                </f:facet>
                <h:outputText value="#{credit.numeroAbonos}"/>
            </p:column>
            
            
            <!-- ****************************** ABONADO ****************************** -->
            <p:column width="7%"  style="color: green; text-align: right;" sortBy="#{credit.abonado}">
                <f:facet name="header">
                    <h:outputText value="Abon." title="Abonado"/>
                </f:facet>
                <h:outputText value="#{credit.abonado}" >
                    <f:convertNumber pattern="###,###"/>
                </h:outputText>
            </p:column>

            
            <!-- ****************************** MONTO PRESTADO ****************************** -->
            <p:column width="7%" style="text-align: right;" sortBy="#{credit.credito.monto}">
                <f:facet name="header"><h:outputText value="M. P." title="Monto Prestado"/></f:facet>
                <h:outputText value="#{credit.credito.monto}">
                    <f:convertNumber pattern="###,###"/>
                </h:outputText>
            </p:column>
            
            
            <!-- ****************************** INTERES ****************************** -->
            <p:column width="6%" style="text-align: right;">
                <f:facet name="header"><h:outputText value="Int." title="Interés" /></f:facet>
                <h:outputText value="#{credit.interes}" >
                    <f:convertNumber pattern="###,###"/>
                </h:outputText>
            </p:column>

            
            <!-- ****************************** FOOTER ****************************** -->
            <p:columnGroup type="footer">
                <p:row>
                    <p:column colspan="9" style="text-align:right" footerText="Totales:" />
                    <p:column footerText="#{cuadreView.totalPorCobrar}" />   
                    <p:column/>   
                    <p:column footerText="#{cuadreView.totalAbonado}" />
                    <p:column footerText="#{cuadreView.totalPrestamos}" />
                    <p:column footerText="#{cuadreView.totalInteres}" />
                </p:row>
            </p:columnGroup>

            <f:facet name="footer">
                <p:outputLabel value="Creditos: #{cuadreView.countCreditos}"/>
            </f:facet>
        </p:dataTable>

        <ui:include src="/creditos/creditDialog.xhtml"/>

        <p:defaultCommand target="marcarAbono" />
        <p:commandButton id="marcarAbono" value="Marcar Abono" actionListener="#{cuadreView.marcarAbono()}" 
                         oncomplete="PF('wvAbonos').clearFilters()" update="dtAbonos,idCreditoFocus" style="display: none"/>

    </p:tab>


</html>

